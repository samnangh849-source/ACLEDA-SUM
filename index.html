<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីគណនាទឹកប្រាក់ (ACLEDA & ABA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #0d1117;
            background-image: radial-gradient(circle at 1px 1px, #21262d 1px, transparent 0);
            background-size: 20px 20px;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #161b22;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
            border: 2px solid #161b22;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
        .main-container {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .stat-card {
            background-color: #21262d;
            border: 1px solid #30363d;
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
            transform: translateX(-100%);
            transition: 0.5s;
        }
        .stat-card:hover::after {
            transform: translateX(100%);
        }
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(0, 191, 255, 0.15);
            border-color: #58a6ff;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #8b949e;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #c9d1d9;
        }
        .glowing-border {
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .glowing-border::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -2px;
            border-radius: inherit;
            background: linear-gradient(to right, #0077b6, #00b4d8, #48cae4);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .main-container:hover .glowing-border::before {
             opacity: 1;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse-slow {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(56, 189, 248, 0)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 10px rgba(56, 189, 248, 0.3)); }
        }
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        .animate-pulse-slow {
            animation: pulse-slow 3s infinite ease-in-out;
        }
        .animate-slide-up-item {
            opacity: 0;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        .animate-pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        .result-container-anim {
            animation: slideDown 0.6s ease-out forwards;
        }

        /* Button Hover Glow */
        .btn-glow {
            transition: all 0.3s ease;
        }
        .btn-glow:hover {
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5);
            transform: translateY(-2px);
        }
        
        /* Smooth height transition for result section */
        #result-section {
            transition: all 0.5s ease-in-out;
        }

    </style>
</head>
<body class="text-gray-300">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 animate-[fadeIn_1s_ease-out]">
            <!-- Updated Logo Area to represent both banks visually -->
            <div class="flex justify-center items-center gap-6 mb-6">
                <!-- ACLEDA Logo (Image) -->
                <div class="relative group animate-pulse-slow">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full opacity-75 group-hover:opacity-100 transition duration-200 blur"></div>
                    <img src="https://media.startupcambodia.gov.kh/platform/core/stakeholder/logos/a195e4d7-065e-47da-bcfd-4fea7c33920b.jpg" 
                         alt="ACLEDA" 
                         class="relative h-16 w-16 rounded-full object-cover border-2 border-white bg-white p-1 transition-transform duration-300 group-hover:rotate-6"
                         onerror="this.src='https://via.placeholder.com/64?text=ACLEDA'">
                </div>
                
                <div class="text-gray-500 font-bold text-xl animate-[popIn_0.5s_ease-out_0.5s_backwards]">+</div>
                
                <!-- ABA Logo (Image) -->
                <div class="relative group animate-pulse-slow" style="animation-delay: 1.5s;">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full opacity-75 group-hover:opacity-100 transition duration-200 blur"></div>
                    <img src="https://play-lh.googleusercontent.com/WU6sZMD1UspzwqYnlACtmN60rckp8hoINSgsR21mKLJBbsHPwXtzwvOocpjC7FcO1g=w240-h480-rw" 
                         alt="ABA" 
                         class="relative h-16 w-16 rounded-full object-cover border-2 border-white bg-white transition-transform duration-300 group-hover:-rotate-6"
                         onerror="this.src='https://via.placeholder.com/64?text=ABA'">
                </div>
            </div>
            
            <h1 data-lang-key="title" class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 bg-300% animate-gradient">កម្មវិធីគណនាទឹកប្រាក់ (ACLEDA & ABA)</h1>
            <p data-lang-key="subtitle" class="text-gray-400 mt-2 opacity-0 animate-[slideUp_0.8s_ease-out_0.3s_forwards]">បញ្ចូលអត្ថបទប្រតិបត្តិការ ACLEDA ឬ ABA ដើម្បីគណនា</p>
        </header>

        <!-- Language Switcher -->
        <div class="flex justify-center mb-6 gap-2 opacity-0 animate-[slideUp_0.8s_ease-out_0.5s_forwards]">
            <button id="lang-km" class="px-4 py-2 text-sm font-medium rounded-md transition-all duration-300 transform active:scale-95">ខ្មែរ</button>
            <button id="lang-en" class="px-4 py-2 text-sm font-medium rounded-md transition-all duration-300 transform active:scale-95">English</button>
        </div>

        <main class="main-container glowing-border p-6 md:p-8">
            <!-- Input Section -->
            <div class="mb-6 group">
                <label for="transaction-input" data-lang-key="inputLabel" class="block mb-2 text-sm font-medium text-gray-400 transition-colors group-focus-within:text-cyan-400">បញ្ចូលអត្ថបទប្រតិបត្តិការនៅទីនេះ៖</label>
                <textarea id="transaction-input" rows="10" class="custom-scrollbar bg-[#0d1117] border border-gray-600 text-gray-300 text-sm rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 block w-full p-4 placeholder-gray-600 transition-all duration-300 shadow-inner focus:shadow-[0_0_20px_rgba(6,182,212,0.1)]" placeholder="ឧទាហរណ៍: 
ACLEDA: Received 56.00 USD from...
ABA: $34.00 paid by... ឬ ៛51,000 paid by..."></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                <button id="calculate-btn" data-lang-key="calculateBtn" class="btn-glow w-full text-white bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 focus:ring-4 focus:outline-none focus:ring-cyan-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition-all duration-300 active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calculator-fill animate-[pulse_2s_infinite]" viewBox="0 0 16 16"><path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm2 .5v2a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 0-.5-.5h-7a.5.5 0 0 0-.5.5zm0 4v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zM4.5 9a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM4 12.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zM7.5 6a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM7 9.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5zm.5 2.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM10.5 6a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm-.5 2.5a.5.5 0 0 0-.5.5v4a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 0-.5-.5h-1z"/></svg>
                    <span>គណនាទឹកប្រាក់</span>
                </button>
                <button id="clear-btn" data-lang-key="clearBtn" class="w-full text-white bg-gray-700 hover:bg-gray-600 hover:text-red-400 focus:ring-4 focus:outline-none focus:ring-gray-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition-all duration-300 transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2 border border-transparent hover:border-red-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/></svg>
                    <span>សម្អាត</span>
                </button>
            </div>

            <!-- Result Section -->
            <div id="result-section" class="hidden result-container-anim">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-6">
                    <h2 data-lang-key="resultsTitle" class="text-2xl font-semibold text-cyan-400 animate-[fadeIn_0.5s_ease-out]">លទ្ធផល</h2>
                    <button id="copy-btn" data-lang-key="copyBtn" class="text-sm bg-gray-700 hover:bg-gray-600 text-cyan-400 font-medium py-2 px-3 rounded-lg transition-all duration-300 flex items-center gap-2 hover:scale-105 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                        <span>ចម្លងលទ្ធផល</span>
                    </button>
                </div>

                <!-- Total Amount -->
                <div class="bg-gradient-to-br from-green-500/10 to-cyan-500/10 rounded-lg p-6 mb-6 text-center border border-green-400/20 transform transition-transform hover:scale-[1.02] duration-300 shadow-lg shadow-green-900/10 animate-pop-in">
                    <p data-lang-key="totalLabel" class="text-gray-400 text-lg">ទឹកប្រាក់សរុបជាដុល្លារ</p>
                    <p id="total-amount" class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-300 tracking-wider mt-2">0.00 USD</p>
                </div>
                
                <!-- Transaction Period -->
                <div id="transaction-period-container" class="bg-[#0d1117] rounded-lg p-4 mb-6 text-center text-gray-400 border border-gray-700 hidden animate-[fadeIn_0.8s_ease-out]">
                    <p id="transaction-period-text" class="leading-relaxed"></p>
                </div>
                
                <!-- Summary Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="summary-stats">
                    <!-- Stats will be injected here -->
                </div>

                <!-- Currency Breakdown -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="currency-breakdown">
                    <!-- Breakdown will be injected here -->
                </div>
                
                <!-- Sender Breakdown -->
                <div class="mt-6 opacity-0 animate-[slideUp_0.5s_ease-out_0.2s_forwards]" style="animation-delay: 0.2s;">
                    <h3 data-lang-key="senderBreakdownTitle" class="text-lg font-semibold text-gray-300 mb-3">សរុបតាមអ្នកផ្ញើ៖</h3>
                    <div id="sender-breakdown-list" class="custom-scrollbar max-h-60 overflow-y-auto space-y-2 pr-2">
                        <!-- Sender stats will be injected here -->
                    </div>
                </div>

                <!-- Transaction List -->
                <div class="mt-6 opacity-0 animate-[slideUp_0.5s_ease-out_0.3s_forwards]" style="animation-delay: 0.3s;">
                    <h3 data-lang-key="foundTransactions" class="text-lg font-semibold text-gray-300 mb-3">ប្រតិបត្តិការដែលបានរកឃើញ៖</h3>
                    <div id="transaction-list" class="custom-scrollbar max-h-60 overflow-y-auto space-y-2 pr-2">
                        <!-- Transactions will be injected here -->
                    </div>
                </div>
                
                <!-- Telegram Section -->
                <div id="telegram-section" class="mt-8 border-t border-gray-700 pt-6 opacity-0 animate-[slideUp_0.5s_ease-out_0.4s_forwards]" style="animation-delay: 0.4s;">
                    <button id="telegram-btn" class="w-full text-white bg-blue-600 hover:bg-blue-500 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition-all duration-300 transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2 shadow-lg shadow-blue-900/30">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="bi bi-telegram"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.226.63.42.996.61.28.14.558.28.84.354.288.077.456.033.532-.198.09-.288.108-.62.168-1.034.163-1.14.404-2.531.624-3.517.145-.782.04-1.447-.168-1.847-.212-.41-.582-.662-1.018-.795-.438-.133-1.045-.248-1.703-.393zm-3.19 8.24c.22-.24.42-.48.62-.72s.46-.52.73-.82c.27-.3.58-.61.92-.93.34-.32.68-.62 1.02-.92s.68-.6 1.02-.9c.34-.3.68-.6.98-.86.3-.26.59-.51.85-.73.27-.23.5-.42.69-.58.19-.17.34-.3.46-.41.12-.11.2-.19.26-.25.06-.06.1-.09.12-.11s.05-.04.05-.04l-.002-.002-.002-.002-.001-.001a.15.15 0 0 0-.01-.01.1.1 0 0 0-.02-.016c-.01-.005-.02-.01-.03-.013a.3.3 0 0 0-.03-.01.15.15 0 0 0-.04-.01z"/></svg>
                        <span data-lang-key="telegramBtn">បញ្ជូនទៅ Telegram</span>
                    </button>
                    <p id="telegram-status" class="text-center text-sm mt-2 text-gray-500 h-4"></p>
                </div>
            </div>
        </main>

        <footer class="text-center text-gray-500 mt-8 text-sm animate-[fadeIn_1s_ease-out_1s_backwards]">
            <p data-lang-key="footerText">&copy; 2025 | បង្កើតឡើងដើម្បីសម្រួលការគណនារបស់អ្នក (ACLEDA & ABA)</p>
        </footer>
    </div>
    
    <!-- Hidden Report Card for Image Generation -->
    <div id="report-card-container" class="fixed top-0 left-[-9999px] p-8 bg-[#0d1117]">
         <div id="report-card" class="w-[500px] bg-gradient-to-br from-[#161b22] to-[#21262d] text-gray-300 p-6 rounded-lg shadow-2xl border border-gray-700" style="font-family: 'Kantumruy Pro', sans-serif;">
            <!-- Header -->
            <div class="text-center mb-4 border-b border-gray-700 pb-3 flex flex-col items-center">
                 <div class="flex gap-4 mb-3 justify-center items-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/Acleda_Bank_Logo.jpg/600px-Acleda_Bank_Logo.jpg" 
                         alt="ACLEDA" 
                         class="h-12 w-12 rounded-full object-cover border-2 border-white bg-white p-0.5"
                         onerror="this.src='https://via.placeholder.com/64?text=ACLEDA'">
                    <img src="https://www.ababank.com/fileadmin/aba/logos/ABA_Logo_Icon.png" 
                         alt="ABA" 
                         class="h-12 w-12 rounded-full object-cover border-2 border-white bg-white"
                         onerror="this.src='https://via.placeholder.com/64?text=ABA'">
                 </div>
                 <h2 data-lang-key="resultsTitle" class="text-xl font-bold text-cyan-400">លទ្ធផលសរុប</h2>
            </div>
            <!-- Total -->
            <div class="text-center my-4 p-4 bg-green-900/50 rounded-lg border border-green-400/30">
                 <p data-lang-key="totalLabel" class="text-gray-400 text-md">ទឹកប្រាក់សរុបជាដុល្លារ</p>
                 <p id="report-total-amount" class="text-4xl font-bold text-green-300">0.00 USD</p>
            </div>
            <!-- Period -->
            <div id="report-period" class="text-center text-sm text-gray-400 mb-4 p-3 bg-gray-900/70 rounded-md"></div>
            <!-- Stats -->
            <div class="grid grid-cols-2 gap-3 text-center text-sm mb-3">
                 <div class="bg-gray-700 p-2 rounded-md">
                     <p data-lang-key="statTotalTransactions" class="text-gray-400">ប្រតិបត្តិការសរុប</p>
                     <p id="report-stat-count" class="font-bold text-lg text-white">0</p>
                 </div>
                 <div class="bg-gray-700 p-2 rounded-md">
                     <p data-lang-key="statAverage" class="text-gray-400">ជាមធ្យម</p>
                     <p id="report-stat-average" class="font-bold text-lg text-white">0.00 USD</p>
                 </div>
                 <div class="bg-gray-700 p-2 rounded-md">
                     <p data-lang-key="statHighest" class="text-gray-400">ខ្ពស់បំផុត</p>
                     <p id="report-stat-highest" class="font-bold text-lg text-green-400">0.00 USD</p>
                 </div>
                 <div class="bg-gray-700 p-2 rounded-md">
                     <p data-lang-key="statLowest" class="text-gray-400">ទាបបំផុត</p>
                     <p id="report-stat-lowest" class="font-bold text-lg text-red-400">0.00 USD</p>
                 </div>
            </div>
             <!-- Breakdown -->
            <div class="text-sm bg-gray-900/70 p-3 rounded-md">
                <p data-lang-key="currencyBreakdown" class="text-center font-semibold text-gray-300 mb-2">សរុបតាមរូបិយប័ណ្ណ</p>
                <div class="flex justify-around">
                     <div>
                         <span class="text-gray-400" data-lang-key="usdTransactions">USD</span>: <span id="report-usd-count" class="font-bold text-white">0</span>
                     </div>
                     <div>
                          <span class="text-gray-400" data-lang-key="khrTransactions">KHR</span>: <span id="report-khr-count" class="font-bold text-white">0</span>
                     </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="text-center text-xs text-gray-500 mt-4 border-t border-gray-700 pt-2">
                <p>Generated on: <span id="report-timestamp"></span></p>
            </div>
        </div>
    </div>

    <!-- Load the configuration file BEFORE the main script -->
    <script src="telegram_config.js"></script>
    
    <script>
        const calculateBtn = document.getElementById('calculate-btn');
        const clearBtn = document.getElementById('clear-btn');
        const copyBtn = document.getElementById('copy-btn');
        const telegramBtn = document.getElementById('telegram-btn');
        const transactionInput = document.getElementById('transaction-input');
        const resultSection = document.getElementById('result-section');
        const totalAmountEl = document.getElementById('total-amount');
        const transactionListEl = document.getElementById('transaction-list');
        const langKmBtn = document.getElementById('lang-km');
        const langEnBtn = document.getElementById('lang-en');
        const transactionPeriodContainer = document.getElementById('transaction-period-container');
        const transactionPeriodText = document.getElementById('transaction-period-text');
        const summaryStatsEl = document.getElementById('summary-stats');
        const currencyBreakdownEl = document.getElementById('currency-breakdown');
        const telegramStatus = document.getElementById('telegram-status');


        let currentLanguage = 'km';
        let lastResults = {};

        const translations = {
            en: {
                title: "Transaction Calculator (ACLEDA & ABA)",
                subtitle: "Paste transaction text from ACLEDA or ABA Bank.",
                inputLabel: "Enter transaction text here:",
                inputPlaceholder: "Example:\nACLEDA: Received 56.00 USD from...\nABA: $34.00 paid by... or ៛51,000 paid by...",
                calculateBtn: "Calculate Total",
                clearBtn: "Clear",
                copyBtn: "Copy Results",
                copied: "Copied!",
                resultsTitle: "Results",
                totalLabel: "Total Amount in USD",
                foundTransactions: "Transactions Found:",
                footerText: "© 2025 | ACLEDA & ABA Calculator",
                alertMsg: "Please enter transaction text first.",
                noTransactionsFound: 'No valid transactions found.',
                khrConversionTemplate: "(Converted to {amount} USD)",
                periodSameDay: "Total amount from {startTime} to {endTime} on {date}.",
                periodDifferentDays: "Total amount from {startDate} to {endDate}.",
                statTotalTransactions: "Total Transactions",
                statAverage: "Average",
                statHighest: "Highest",
                statLowest: "Lowest",
                usdTransactions: "USD Txns",
                khrTransactions: "KHR Txns",
                total: "Total",
                currencyBreakdown: "Currency Breakdown",
                telegramBtn: "Send to Telegram",
                sending: "Sending...",
                sent: "Successfully Sent!",
                sendError: "Failed to send. Check console.",
                telegramConfigError: "Telegram config not found. Check telegram_config.js file.",
                telegramImageGenerating: "Generating report image...",
                telegramImageError: "Failed to create image.",
                senderBreakdownTitle: "Breakdown by Sender:",
                noSendersFound: "No sender information found.",
                unknownSender: "Unknown Sender"
            },
            km: {
                title: "កម្មវិធីគណនាទឹកប្រាក់ (ACLEDA & ABA)",
                subtitle: "បញ្ចូលអត្ថបទប្រតិបត្តិការ ACLEDA ឬ ABA ដើម្បីគណនា",
                inputLabel: "បញ្ចូលអត្ថបទប្រតិបត្តិការនៅទីនេះ៖",
                inputPlaceholder: "ឧទាហរណ៍:\nACLEDA: Received 56.00 USD from...\nABA: $34.00 paid by... ឬ ៛51,000 paid by...",
                calculateBtn: "គណនាទឹកប្រាក់",
                clearBtn: "សម្អាត",
                copyBtn: "ចម្លងលទ្ធផល",
                copied: "បានចម្លង!",
                resultsTitle: "លទ្ធផល",
                totalLabel: "ទឹកប្រាក់សរុបជាដុល្លារ",
                foundTransactions: "ប្រតិបត្តិការដែលបានរកឃើញ៖",
                footerText: "© 2025 | បង្កើតឡើងដើម្បីសម្រួលការគណនារបស់អ្នក (ACLEDA & ABA)",
                alertMsg: "សូមបញ្ចូលអត្ថបទប្រតិបត្តិការជាមុនសិន",
                noTransactionsFound: 'រកមិនឃើញប្រតិបត្តិការត្រឹមត្រូវទេ។',
                khrConversionTemplate: "(ប្តូរជា {amount} USD)",
                periodSameDay: "សរុបទឹកប្រាក់ចាប់ពី {startTime} ដល់ {endTime} នៅថ្ងៃទី {date}",
                periodDifferentDays: "សរុបទឹកប្រាក់ចន្លោះពី {startDate} ដល់ {endDate}",
                statTotalTransactions: "ប្រតិបត្តិការសរុប",
                statAverage: "ជាមធ្យម",
                statHighest: "ខ្ពស់បំផុត",
                statLowest: "ទាបបំផុត",
                usdTransactions: "ប្រតិបត្តិការ USD",
                khrTransactions: "ប្រតិបត្តិការ KHR",
                total: "សរុប",
                currencyBreakdown: "សរុបតាមរូបិយប័ណ្ណ",
                telegramBtn: "បញ្ជូនទៅ Telegram",
                sending: "កំពុងបញ្ជូន...",
                sent: "បានបញ្ជូនដោយជោគជ័យ!",
                sendError: "សូមពិនិត្យ Console",
                telegramConfigError: "រកមិនឃើញ Telegram ទេ។ សូមពិនិត្យឯកសារ telegram_config.js",
                telegramImageGenerating: "កំពុងបង្កើតរូបភាពរបាយការណ៍...",
                telegramImageError: "ការបង្កើតរូបភាពបរាជ័យ",
                senderBreakdownTitle: "សរុបតាមអ្នកផ្ញើ៖",
                noSendersFound: "មិនអាចទាញយកព័ត៌មានអ្នកផ្ញើបានទេ។",
                unknownSender: "អ្នកផ្ញើមិនស្គាល់"
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    const target = el.querySelector('span') || el;
                    target.textContent = translations[lang][key];
                }
            });
            transactionInput.placeholder = translations[lang].inputPlaceholder;

            if (lang === 'km') {
                langKmBtn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-all duration-300 bg-cyan-600 text-white shadow-md shadow-cyan-500/20 ring-2 ring-cyan-500/50';
                langEnBtn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-all duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white';
            } else {
                langEnBtn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-all duration-300 bg-cyan-600 text-white shadow-md shadow-cyan-500/20 ring-2 ring-cyan-500/50';
                langKmBtn.className = 'px-4 py-2 text-sm font-medium rounded-md transition-all duration-300 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white';
            }
            if (!resultSection.classList.contains('hidden')) {
                displayResults(lastResults.total, lastResults.transactions, lastResults.minDate, lastResults.maxDate, lastResults.stats, lastResults.senderData);
            }
        }
        
        function parseCustomDate(dateStr) {
            if (!dateStr) return null;
            try {
                // Remove trailing dots which might come from regex matching end of sentences
                let cleanedStr = dateStr.toLowerCase().trim().replace(/\.$/, '');
                
                // Normalization
                cleanedStr = cleanedStr
                    .replace(/,/g, '')
                    .replace(/-/g, ' ')
                    .replace(/\s+at\s+/i, ' ')
                    .replace(/\s+/g, ' '); 

                const months = {
                    jan: 0, feb: 1, mar: 2, apr: 3, may: 4, jun: 5,
                    jul: 6, aug: 7, sep: 8, oct: 9, nov: 10, dec: 11
                };

                const parts = cleanedStr.split(' ');
                
                // Find date parts based on the month
                const monthIndex = parts.findIndex(p => months[p.substring(0,3)] !== undefined);
                if (monthIndex === -1) return null;
                
                const month = months[parts[monthIndex].substring(0,3)];
                const day = parseInt(parts[monthIndex + 1]); // Usually day follows month (Jan 30) or precedes (30 Jan)
                
                // Check if Day precedes month (e.g. 30 Jan)
                let actualDay = day;
                if(isNaN(day) && monthIndex > 0) {
                     actualDay = parseInt(parts[monthIndex - 1]);
                }

                // Handle Year. ACLEDA usually has it. ABA usually doesn't in the SMS/Telegram text provided.
                // We'll look for a 4-digit year. If not found, use current year.
                let year = new Date().getFullYear(); 
                const yearMatch = cleanedStr.match(/\b20\d{2}\b/);
                if (yearMatch) {
                    year = parseInt(yearMatch[0]);
                }

                // Find time part
                const timePartRaw = parts.find(p => p.includes(':'));
                if (!timePartRaw) return null;

                const timeMatch = timePartRaw.match(/(\d{1,2}):(\d{2})/);
                if (!timeMatch) return null;

                let hour = parseInt(timeMatch[1]);
                const minute = parseInt(timeMatch[2]);
                
                if (cleanedStr.includes('pm') && hour < 12) {
                    hour += 12;
                }
                if (cleanedStr.includes('am') && hour === 12) { // Handle 12 AM (midnight)
                    hour = 0;
                }

                if (isNaN(actualDay) || isNaN(year) || isNaN(hour) || isNaN(minute)) return null;

                return new Date(year, month, actualDay, hour, minute);

            } catch (e) {
                console.error("Date parsing error for string:", dateStr, e);
                return null;
            }
        }

        function calculateTotal() {
            const inputText = transactionInput.value;
            if (!inputText.trim()) {
                alert(translations[currentLanguage].alertMsg);
                return;
            }

            let totalUSD = 0, totalKHR = 0;
            let usdCount = 0, khrCount = 0;
            let transactionsFound = [], dateObjects = [];
            let senderData = {};

            // --- 1. ACLEDA PARSING LOGIC ---
            // Pattern: Received 56.00 USD from...
            const acledaAmountRegex = /Received\s+([\d,]+(?:\.\d+)?)\s+(USD|KHR)/gi;
            const acledaMatches = [...inputText.matchAll(acledaAmountRegex)];

            for (let i = 0; i < acledaMatches.length; i++) {
                const currentMatch = acledaMatches[i];
                // Context window: Look for sender/date around the match
                const searchStart = inputText.lastIndexOf('\n', currentMatch.index) + 1;
                const searchEnd = inputText.indexOf('\n', currentMatch.index);
                const block = inputText.substring(searchStart, searchEnd > -1 ? searchEnd : inputText.length);

                // Date Parsing for ACLEDA
                const dateRegex = /\[(.*?)\]|on\s+((?:\d{1,2}[\s-]\w{3}[\s-]\d{4})[\s,]+(?:at\s+)?(?:\d{1,2}:\d{2}(?::\d{2})?\s*(?:AM|PM)?))/i;
                const dateMatch = block.match(dateRegex);
                if (dateMatch) {
                    const dateString = dateMatch[1] || dateMatch[2];
                    const parsedDate = parseCustomDate(dateString);
                    if (parsedDate) dateObjects.push(parsedDate);
                }

                // Sender Parsing for ACLEDA
                const senderRegex = /from\s(.*?)(?:,ABA Bank|by KHQR|\s\s|,on|,at|$)/i;
                const senderMatch = block.match(senderRegex);
                let senderName = translations[currentLanguage].unknownSender;
                if (senderMatch && senderMatch[1].trim()) {
                    senderName = senderMatch[1].trim().replace(/,$/, '');
                }

                processTransaction(currentMatch[1], currentMatch[2], "ACLEDA", senderName);
            }

            // --- 2. ABA PARSING LOGIC ---
            // Pattern USD: $34.00 paid by ... on ...
            // Pattern KHR: ៛51,000 paid by ... on ...
            // Using a regex that captures symbol ($ or ៛), amount, sender, date
            const abaRegex = /([$៛])\s*([\d,]+(?:\.\d+)?)\s+paid\s+by\s+(.*?)(?:\(\*\d+\))?\s+on\s+(.*?)(?:\s+via|\s+at|\s+Remark|\.$)/gi;
            const abaMatches = [...inputText.matchAll(abaRegex)];

            for (const match of abaMatches) {
                const symbol = match[1];
                const amountStr = match[2];
                const senderRaw = match[3];
                const dateRaw = match[4];

                const currency = symbol === '$' ? 'USD' : 'KHR';
                const senderName = senderRaw.trim();

                // Date Parsing for ABA (Defaulting to current year if missing)
                const parsedDate = parseCustomDate(dateRaw);
                if (parsedDate) dateObjects.push(parsedDate);

                processTransaction(amountStr, currency, "ABA", senderName);
            }

            function processTransaction(amountStr, currency, source, senderName) {
                const amount = parseFloat(amountStr.replace(/,/g, ''));
                let amountInUSD = amount;
                let isKHR = false;
                let originalText = "";

                if (currency === 'KHR') {
                    khrCount++;
                    totalKHR += amount;
                    amountInUSD = amount / 4000;
                    isKHR = true;
                    // Format display text
                    if(source === "ABA") originalText = `៛${amount.toLocaleString('en-US')} paid by ${senderName}`;
                    else originalText = `Received ${amount.toLocaleString('en-US')} KHR from ${senderName}`;
                } else {
                    usdCount++;
                    // Format display text
                    if(source === "ABA") originalText = `$${amount.toLocaleString('en-US')} paid by ${senderName}`;
                    else originalText = `Received ${amount.toLocaleString('en-US')} USD from ${senderName}`;
                }

                totalUSD += amountInUSD;
                
                // Tag the source for display (optional, adding a small badge text)
                const sourceBadge = source === "ABA" ? "[ABA]" : "[ACLEDA]";
                
                transactionsFound.push({ 
                    text: `${sourceBadge} ${originalText}`, 
                    value: amountInUSD, 
                    isKHR: isKHR, 
                    sender: senderName 
                });

                // Update Sender Stats
                if (senderData[senderName]) {
                    senderData[senderName].count++;
                    senderData[senderName].total += amountInUSD;
                } else {
                    senderData[senderName] = { count: 1, total: amountInUSD };
                }
            }

            // --- Final Calculations ---
            
            let minDate = null, maxDate = null;
            if (dateObjects.length > 0) {
                minDate = new Date(Math.min.apply(null, dateObjects));
                maxDate = new Date(Math.max.apply(null, dateObjects));
            }
            
            const count = transactionsFound.length;
            const values = transactionsFound.map(t => t.value);
            const stats = {
                count,
                average: count > 0 ? (totalUSD / count) : 0,
                highest: count > 0 ? Math.max(...values) : 0,
                lowest: count > 0 ? Math.min(...values) : 0,
                usdCount,
                khrCount,
                totalKHR
            };

            displayResults(totalUSD, transactionsFound, minDate, maxDate, stats, senderData);
        }
        
        function displayResults(total, transactions, minDate, maxDate, stats, senderData) {
            lastResults = {total, transactions, minDate, maxDate, stats, senderData};
            resultSection.classList.remove('hidden');
            
            // Animation reset technique
            resultSection.classList.remove('result-container-anim');
            void resultSection.offsetWidth; // Trigger reflow
            resultSection.classList.add('result-container-anim');

            totalAmountEl.textContent = `${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USD`;
            
            transactionPeriodContainer.classList.add('hidden');
            if (minDate && maxDate) {
                const optionsDate = { year: 'numeric', month: 'long', day: 'numeric' };
                const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: true };
                const locale = currentLanguage === 'km' ? 'km-KH' : 'en-US';

                const minDateStr = minDate.toLocaleDateString('fr-CA');
                const maxDateStr = maxDate.toLocaleDateString('fr-CA');
                
                let periodHTML = '';
                if (minDateStr === maxDateStr) {
                    const startTime = minDate.toLocaleTimeString(locale, optionsTime);
                    const endTime = maxDate.toLocaleTimeString(locale, optionsTime);
                    const dateDisplay = minDate.toLocaleDateString(locale, optionsDate);
                    periodHTML = translations[currentLanguage].periodSameDay
                        .replace('{startTime}', `<span class="font-semibold text-white">${startTime}</span>`)
                        .replace('{endTime}', `<span class="font-semibold text-white">${endTime}</span>`)
                        .replace('{date}', `<span class="font-semibold text-white">${dateDisplay}</span>`);
                } else {
                    const startDateTime = minDate.toLocaleString(locale, {...optionsDate, ...optionsTime});
                    const endDateTime = maxDate.toLocaleString(locale, {...optionsDate, ...optionsTime});
                    periodHTML = translations[currentLanguage].periodDifferentDays
                        .replace('{startDate}', `<span class="font-semibold text-white">${startDateTime}</span>`)
                        .replace('{endDate}', `<span class="font-semibold text-white">${endDateTime}</span>`);
                }
                transactionPeriodText.innerHTML = periodHTML;
                transactionPeriodContainer.classList.remove('hidden');
            }

            // Stats with staggered delays
            summaryStatsEl.innerHTML = `
                <div class="stat-card animate-slide-up-item" style="animation-delay: 0.1s"><div class="stat-label">${translations[currentLanguage].statTotalTransactions}</div><div class="stat-value">${stats.count || 0}</div></div>
                <div class="stat-card animate-slide-up-item" style="animation-delay: 0.2s"><div class="stat-label">${translations[currentLanguage].statAverage}</div><div class="stat-value">${(stats.average || 0).toFixed(2)} USD</div></div>
                <div class="stat-card animate-slide-up-item" style="animation-delay: 0.3s"><div class="stat-label">${translations[currentLanguage].statHighest}</div><div class="stat-value text-green-400">${(stats.highest || 0).toFixed(2)} USD</div></div>
                <div class="stat-card animate-slide-up-item" style="animation-delay: 0.4s"><div class="stat-label">${translations[currentLanguage].statLowest}</div><div class="stat-value text-red-400">${(stats.lowest || 0).toFixed(2)} USD</div></div>`;
            
            currencyBreakdownEl.innerHTML = `
                <div class="stat-card animate-slide-up-item" style="animation-delay: 0.5s"><div class="stat-label">${translations[currentLanguage].usdTransactions}</div><div class="stat-value">${stats.usdCount || 0}</div></div>
                <div class="stat-card animate-slide-up-item" style="animation-delay: 0.6s"><div class="stat-label">${translations[currentLanguage].khrTransactions}</div><div class="stat-value">${stats.khrCount || 0} <span class="text-sm text-gray-400">(${(stats.totalKHR || 0).toLocaleString('en-US')} KHR)</span></div></div>`;
            
            const senderListEl = document.getElementById('sender-breakdown-list');
            senderListEl.innerHTML = '';
            if (senderData && Object.keys(senderData).length > 0 && total > 0) {
                const sortedSenders = Object.entries(senderData).sort(([,a],[,b]) => b.total - a.total);
                
                sortedSenders.forEach(([name, data], index) => {
                    const div = document.createElement('div');
                    // Add staggered delay based on index
                    div.className = 'bg-gray-800/50 p-3 rounded-md text-sm border border-gray-700 animate-slide-up-item hover:bg-gray-700/50 transition-colors';
                    div.style.animationDelay = `${0.3 + (index * 0.05)}s`;
                    
                    const percentage = (data.total / total) * 100;
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-gray-300 truncate pr-2">${name} (${data.count})</span>
                            <span class="font-semibold text-cyan-400 whitespace-nowrap">${data.total.toFixed(2)} USD</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-2 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                    `;
                    senderListEl.appendChild(div);
                    // Animate progress bar width after a small delay
                    setTimeout(() => {
                        div.querySelector('.bg-gradient-to-r').style.width = `${percentage}%`;
                    }, 500 + (index * 50));
                });
            } else {
                senderListEl.innerHTML = `<p class="text-gray-500 text-center p-4">${translations[currentLanguage].noSendersFound}</p>`;
            }

            transactionListEl.innerHTML = '';
            if (transactions.length > 0) {
                 transactions.forEach((t, index) => {
                    const li = document.createElement('div');
                    // Staggered animation
                    li.className = 'bg-gray-800/50 p-3 rounded-md flex justify-between items-center text-sm border border-gray-700 animate-slide-up-item hover:bg-gray-700/50 transition-colors group';
                    li.style.animationDelay = `${0.4 + (index * 0.05)}s`;
                    
                    const textSpan = document.createElement('span');
                    textSpan.className = 'text-gray-300 break-words w-2/3 group-hover:text-white transition-colors'; // Allow wrapping
                    
                    let conversionText = '';
                    if (t.isKHR) {
                         conversionText = ` <span class="text-xs text-gray-500 block mt-1">${translations[currentLanguage].khrConversionTemplate.replace('{amount}', t.value.toFixed(2))}</span>`;
                    }
                    textSpan.innerHTML = t.text + conversionText;

                    const valueSpan = document.createElement('span');
                    valueSpan.className = 'font-semibold text-green-400 ml-4 whitespace-nowrap group-hover:scale-110 transition-transform';
                    valueSpan.textContent = `+${t.value.toFixed(2)} USD`;
                    li.appendChild(textSpan);
                    li.appendChild(valueSpan);
                    transactionListEl.appendChild(li);
                });
            } else {
                transactionListEl.innerHTML = `<p class="text-gray-500 text-center p-4">${translations[currentLanguage].noTransactionsFound}</p>`;
            }

            document.getElementById('report-total-amount').textContent = `${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USD`;
            document.getElementById('report-stat-count').textContent = stats.count || 0;
            document.getElementById('report-stat-average').textContent = `${(stats.average || 0).toFixed(2)} USD`;
            document.getElementById('report-stat-highest').textContent = `${(stats.highest || 0).toFixed(2)} USD`;
            document.getElementById('report-stat-lowest').textContent = `${(stats.lowest || 0).toFixed(2)} USD`;
            document.getElementById('report-usd-count').textContent = stats.usdCount || 0;
            document.getElementById('report-khr-count').textContent = stats.khrCount || 0;
            const reportPeriodEl = document.getElementById('report-period');
            if (minDate && maxDate) {
                  const locale = currentLanguage === 'km' ? 'km-KH' : 'en-US';
                  const options = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
                  
                  if (minDate.toDateString() === maxDate.toDateString()) {
                       const minTimeStr = minDate.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit', hour12: true });
                       const maxTimeStr = maxDate.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit', hour12: true });
                       const dateStr = minDate.toLocaleDateString(locale, { day: '2-digit', month: 'short', year: 'numeric' });
                       reportPeriodEl.textContent = `${dateStr} (${minTimeStr} - ${maxTimeStr})`;
                  } else {
                       const startDateTimeStr = minDate.toLocaleString(locale, options);
                       const endDateTimeStr = maxDate.toLocaleString(locale, options);
                       reportPeriodEl.textContent = `${startDateTimeStr} - ${endDateTimeStr}`;
                  }
            } else {
                reportPeriodEl.textContent = 'N/A';
            }
            const timestampLocale = currentLanguage === 'km' ? 'km-KH' : 'en-US';
            document.getElementById('report-timestamp').textContent = new Date().toLocaleString(timestampLocale, { dateStyle: 'medium', timeStyle: 'short' });
        }
        
        function clearAll() {
            transactionInput.value = '';
            
            // Fade out result section
            resultSection.style.opacity = '0';
            resultSection.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                resultSection.classList.add('hidden');
                resultSection.style.opacity = '';
                resultSection.style.transform = '';
                
                totalAmountEl.textContent = '0.00 USD';
                transactionListEl.innerHTML = '';
                transactionPeriodContainer.classList.add('hidden');
                summaryStatsEl.innerHTML = '';
                currencyBreakdownEl.innerHTML = '';
                telegramStatus.textContent = '';
                lastResults = {};
            }, 300);
        }

        function generateReportText(isMarkdown = false) {
            if(!lastResults.stats || lastResults.stats.count === 0) return "";
            const { total, minDate, maxDate, stats } = lastResults;
            const t = translations[currentLanguage];
            const locale = currentLanguage === 'km' ? 'km-KH' : 'en-US';

            let periodText = '';
            if(minDate && maxDate) {
                  const optionsDate = { year: 'numeric', month: 'long', day: 'numeric' };
                  const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: true };
                  
                  if(minDate.toDateString() === maxDate.toDateString()) {
                      const startTime = minDate.toLocaleTimeString(locale, optionsTime);
                      const endTime = maxDate.toLocaleTimeString(locale, optionsTime);
                      const dateDisplay = minDate.toLocaleDateString(locale, optionsDate);
                      periodText = t.periodSameDay.replace(/{startTime}/g, startTime).replace(/{endTime}/g, endTime).replace(/{date}/g, dateDisplay);
                  } else {
                      const startDateTime = minDate.toLocaleString(locale, {...optionsDate, ...optionsTime});
                      const endDateTime = maxDate.toLocaleString(locale, {...optionsDate, ...optionsTime});
                      periodText = t.periodDifferentDays.replace(/{startDate}/g, startDateTime).replace(/{endDate}/g, endDateTime);
                  }
            }
            
            const b = isMarkdown ? '*' : '';
            const m = isMarkdown ? '`' : '';

            return `
*🧾 ${t.resultsTitle} 🧾*
${periodText.replace(/<\/?span[^>]*>/g, '')}
-----------------------------------
${b}${t.totalLabel}:${b} ${m}${total.toFixed(2)} USD${m}

*📊 ${t.statTotalTransactions}:* ${m}${stats.count}${m}
- ${t.statAverage}: ${m}${stats.average.toFixed(2)} USD${m}
- ${t.statHighest}: ${m}${stats.highest.toFixed(2)} USD${m}
- ${t.statLowest}: ${m}${stats.lowest.toFixed(2)} USD${m}

*💴 ${t.currencyBreakdown}:*
- ${t.usdTransactions}: ${m}${stats.usdCount}${m}
- ${t.khrTransactions}: ${m}${stats.khrCount}${m}
            `.trim().replace(/^ +/gm, '');
        }

        function copyResultsToClipboard() {
            const textToCopy = generateReportText(false);
            if(!textToCopy) return;

            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = copyBtn.querySelector('span').textContent;
                copyBtn.querySelector('span').textContent = translations[currentLanguage].copied;
                
                // Add success animation
                copyBtn.classList.remove('text-cyan-400');
                copyBtn.classList.add('text-green-400', 'scale-110');
                
                setTimeout(() => {
                    copyBtn.querySelector('span').textContent = originalText;
                    copyBtn.classList.add('text-cyan-400');
                    copyBtn.classList.remove('text-green-400', 'scale-110');
                }, 2000);
            });
        }

        async function sendToTelegram() {
            const t = translations[currentLanguage];

            if (typeof TELEGRAM_BOT_TOKEN === 'undefined' || typeof TELEGRAM_CHAT_ID === 'undefined' || !TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
                telegramStatus.textContent = t.telegramConfigError;
                telegramStatus.className = 'text-center text-sm mt-2 text-red-400 h-4';
                return;
            }

            if (!lastResults.stats || lastResults.stats.count === 0) return;

            telegramStatus.textContent = t.telegramImageGenerating;
            telegramStatus.className = 'text-center text-sm mt-2 text-yellow-400 h-4 animate-pulse';
            telegramBtn.disabled = true;
            telegramBtn.classList.add('opacity-75', 'cursor-not-allowed');
            
            const reportCardContainer = document.getElementById('report-card-container');
            reportCardContainer.style.left = '0';
            reportCardContainer.style.opacity = '0';

            try {
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const reportCard = document.getElementById('report-card');
                const canvas = await html2canvas(reportCard, {
                    backgroundColor: '#0d1117',
                    useCORS: true,
                    scale: 2
                });

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.95));
                if (!blob) {
                    throw new Error("Canvas to Blob conversion failed.");
                }

                const formData = new FormData();
                formData.append('chat_id', TELEGRAM_CHAT_ID);
                formData.append('photo', blob, 'report.jpg');
                const captionText = generateReportText(true);
                formData.append('caption', captionText);
                formData.append('parse_mode', 'Markdown');

                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`;

                telegramStatus.textContent = t.sending;

                const response = await fetch(url, { method: 'POST', body: formData });
                const data = await response.json();

                if (data.ok) {
                    telegramStatus.textContent = t.sent;
                    telegramStatus.className = 'text-center text-sm mt-2 text-green-400 h-4';
                } else {
                    throw new Error(data.description);
                }

            } catch (error) {
                telegramStatus.textContent = t.sendError;
                telegramStatus.className = 'text-center text-sm mt-2 text-red-400 h-4';
                console.error("Telegram Send Error:", error);
            } finally {
                 reportCardContainer.style.left = '-9999px';
                 reportCardContainer.style.opacity = '1';
                 telegramBtn.disabled = false;
                 telegramBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }


        calculateBtn.addEventListener('click', calculateTotal);
        clearBtn.addEventListener('click', clearAll);
        copyBtn.addEventListener('click', copyResultsToClipboard);
        telegramBtn.addEventListener('click', sendToTelegram);
        langKmBtn.addEventListener('click', () => setLanguage('km'));
        langEnBtn.addEventListener('click', () => setLanguage('en'));
        
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage('km');
        });
    </script>

</body>
</html>
